<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nimad.visit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-form" id="authForm">
            <div class="auth-header">
                <h1>üåç nimad.visit</h1>
                <p id="authFormTitle">–í—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn-primary" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
                <div class="auth-toggle">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="switchToRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </div>
            </div>
            
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label>–ò–º—è</label>
                    <input type="text" id="registerName" placeholder="–í–∞—à–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="form-group">
                    <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
                    <input type="password" id="registerConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn-primary" onclick="handleRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <div class="auth-toggle">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="switchToLogin()">–í–æ–π—Ç–∏</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="main-app hidden" id="mainApp">
        <div class="header">
            <h2>üåç nimad.visit</h2>
            <button class="logout-btn" onclick="handleLogout()">–í—ã—Ö–æ–¥</button>
        </div>
        
        <div class="content">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ö–∞—Ä—Ç–∞ -->
            <div class="map-section">
                <div id="map"></div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –í–∫–ª–∞–¥–∫–∏ -->
            <div class="right-panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('recommendations')">üìç –ú–µ—Å—Ç–∞</button>
                    <button class="tab-btn" onclick="switchTab('chat')">üí¨ –ü–æ–º–æ—â–Ω–∏–∫</button>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π -->
                <div class="tab-content active" id="recommendationsTab">
                    <div class="gen-form">
                        <div class="form-row">
                            <div class="form-group-inline">
                                <label>–ì–æ—Ä–æ–¥</label>
                                <input type="text" id="cityName" value="Almaty" placeholder="–ì–æ—Ä–æ–¥">
                            </div>
                            <div class="form-group-inline">
                                <label>–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ</label>
                                <select id="userPreferences">
                                    <option value="food">üçΩÔ∏è –ï–¥–∞</option>
                                    <option value="nature">üåø –ü—Ä–∏—Ä–æ–¥–∞</option>
                                    <option value="culture">üé≠ –ö—É–ª—å—Ç—É—Ä–∞</option>
                                    <option value="adventure">‚õ∞Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</option>
                                    <option value="shopping">üõçÔ∏è –®–æ–ø–∏–Ω–≥</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group-inline">
                                <label>–ü–æ–≥–æ–¥–∞</label>
                                <select id="currentWeather">
                                    <option value="warm">‚òÄÔ∏è –¢–µ–ø–ª–æ</option>
                                    <option value="cold">‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–æ</option>
                                    <option value="rainy">üåßÔ∏è –î–æ–∂–¥—å</option>
                                    <option value="cloudy">‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ</option>
                                </select>
                            </div>
                            <div class="form-group-inline">
                                <label>–í—Ä–µ–º—è –¥–Ω—è</label>
                                <select id="timeOfDay">
                                    <option value="—É—Ç—Ä–æ">üåÖ –£—Ç—Ä–æ</option>
                                    <option value="–¥–µ–Ω—å">‚òÄÔ∏è –î–µ–Ω—å</option>
                                    <option value="–≤–µ—á–µ—Ä">üåÜ –í–µ—á–µ—Ä</option>
                                    <option value="–Ω–æ—á—å">üåô –ù–æ—á—å</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row full">
                            <div class="form-group-inline">
                                <label>–°–µ–∑–æ–Ω</label>
                                <select id="season">
                                    <option value="–≤–µ—Å–Ω–∞">üå∏ –í–µ—Å–Ω–∞</option>
                                    <option value="–ª–µ—Ç–æ">‚òÄÔ∏è –õ–µ—Ç–æ</option>
                                    <option value="–æ—Å–µ–Ω—å">üçÇ –û—Å–µ–Ω—å</option>
                                    <option value="–∑–∏–º–∞">‚ùÑÔ∏è –ó–∏–º–∞</option>
                                </select>
                            </div>
                        </div>
                        <button class="gen-btn" id="genBtn" onclick="generateRecommendations()">ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
                    </div>
                    <div class="recommendations" id="recommendationsList">
                        <div style="text-align: center; color: #64748b; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">–ù–∞—á–Ω–∏—Ç–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</div>
                            <div style="font-size: 14px;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>
                        </div>
                    </div>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ —á–∞—Ç–∞ -->
                <div class="tab-content" id="chatTab">
                    <div class="chat-container">
                        <div class="messages" id="chatMessages"></div>
                        <div class="chat-input-group">
                            <input type="text" id="chatInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." onkeypress="handleChatKeyPress(event)">
                            <button class="chat-send-btn" onclick="sendMessage()">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let map = null;
        let markers = {};
        let recommendations = [];
        
        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

        const API_BASE_URL = 'http://localhost:3006/api/v1';
        let currentUser = null;
        let accessToken = null;
        let refreshToken = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        function loadTokens() {
            accessToken = localStorage.getItem('accessToken');
            refreshToken = localStorage.getItem('refreshToken');
            const userData = localStorage.getItem('userData');
            
            if (accessToken && userData) {
                currentUser = JSON.parse(userData);
                showMainApp();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ localStorage
        function saveTokens(access, refresh, user) {
            accessToken = access;
            refreshToken = refresh;
            currentUser = user;
            
            localStorage.setItem('accessToken', access);
            if (refresh) {
                localStorage.setItem('refreshToken', refresh);
            }
            localStorage.setItem('userData', JSON.stringify(user));
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
        function clearAuth() {
            accessToken = null;
            refreshToken = null;
            currentUser = null;
            
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userData');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token
        async function refreshAccessToken() {
            if (!refreshToken) {
                console.log('–ù–µ—Ç refresh token');
                return false;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/refresh-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        token: refreshToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token || data.accessToken;
                    if (data.refresh_token || data.refreshToken) {
                        refreshToken = data.refresh_token || data.refreshToken;
                        localStorage.setItem('refreshToken', refreshToken);
                    }
                    localStorage.setItem('accessToken', accessToken);
                    return true;
                } else {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', response.status);
                    handleLogout();
                    return false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
                handleLogout();
                return false;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–∏–Ω–∞
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                console.log('Login response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
                    alert(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${errorData.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ'}`);
                    return;
                }

                const data = await response.json();
                console.log('Login response:', data);

                // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∞—à–µ–≥–æ API: { access_token: "..." }
                saveTokens(
                    data.access_token,
                    data.refresh_token || null,
                    { 
                        email: email, 
                        name: email.split('@')[0]
                    }
                );
                showMainApp();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + error.message);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        async function handleRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            
            if (!name || !email || !password || !confirm) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            if (password !== confirm) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email,
                        username: name,
                        password,
                        role: 'user'
                    })
                });

                console.log('Register response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
                    alert(`–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${errorData.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π email'}`);
                    return;
                }

                const data = await response.json();
                console.log('Register response:', data);
                
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                switchToLogin();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + error.message);
            }
        }

        function switchToRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('authFormTitle').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
        }

        function switchToLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('authFormTitle').textContent = '–í—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ';
        }

        function handleLogout() {
            clearAuth();
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        async function authenticatedFetch(url, options = {}) {
            if (!accessToken) {
                throw new Error('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
            
            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            };

            let response = await fetch(url, options);

            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ (401), –ø–æ–ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
            if (response.status === 401) {
                console.log('–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å...');
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    options.headers['Authorization'] = `Bearer ${accessToken}`;
                    response = await fetch(url, options);
                } else {
                    throw new Error('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                }
            }

            return response;
        }
        window.addEventListener('DOMContentLoaded', loadTokens);

        
        function clearAuth() {
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirm').value = '';
        }
        
        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            initMap();
            initChat();
        }
        
        // –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ä—Ç–æ–π
        function initMap() {
            if (map) map.remove();
            
            map = L.map('map').setView([43.238949, 76.945465], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
        }
        
        function addMarkersToMap(recs) {
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};
            
            recs.forEach((place, idx) => {
                const baseLat = 43.238949;
                const baseLng = 76.945465;
                const lat = baseLat + (Math.random() - 0.5) * 0.1;
                const lng = baseLng + (Math.random() - 0.5) * 0.1;
                
                const marker = L.marker([lat, lng]).addTo(map);
                
                marker.bindPopup(`
                    <div style="font-weight: 700; color: #1e293b; margin-bottom: 5px;">${place.placeName}</div>
                    <div style="font-size: 12px; color: #64748b;">${place.description}</div>
                `);
                
                markers[idx] = marker;
            });
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        async function generateRecommendations() {
            const btn = document.getElementById('genBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
            if (!accessToken) {
                alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                btn.disabled = false;
                btn.textContent = 'ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏';
                handleLogout();
                return;
            }
            
            const payload = {
                cityName: document.getElementById('cityName').value,
                userPreferences: document.getElementById('userPreferences').value,
                currentWeather: document.getElementById('currentWeather').value,
                timeOfDay: document.getElementById('timeOfDay').value,
                season: document.getElementById('season').value
            };
            
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/recomendations/generate`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
                    throw new Error(errorData.message || `–û—à–∏–±–∫–∞ ${response.status}`);
                }
                
                const data = await response.json();
                recommendations = data.recommendations || [];
                loadRecommendations();
                addMarkersToMap(recommendations);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: ' + error.message);
                document.getElementById('recommendationsList').innerHTML = `
                    <div style="padding: 40px 20px; color: #ef4444; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                        <div style="font-size: 14px;">${error.message}</div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏';
            }
        }


        
        function loadRecommendations() {
            const list = document.getElementById('recommendationsList');
            const form = document.querySelector('.gen-form');
            list.innerHTML = '';
            
            if (recommendations.length === 0) {
                form.classList.remove('collapsed');
                list.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">–ù–∞—á–Ω–∏—Ç–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</div>
                        <div style="font-size: 14px;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>
                    </div>
                `;
                return;
            }
            
            form.classList.add('collapsed');
            
            recommendations.forEach((place, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => {
                    if (markers[idx]) {
                        const marker = markers[idx];
                        map.setView(marker.getLatLng(), 15);
                        marker.openPopup();
                    }
                };
                
                card.innerHTML = `
                    <div class="card-title">${place.placeName}</div>
                    <div class="card-desc">${place.description}</div>
                    <div class="card-reason">üí° ${place.reason}</div>
                    <div class="card-meta">
                        <span class="meta-item">üí∞ ${place.estimatedPrice}</span>
                        <span class="meta-item">üïê ${place.timeToVisit}</span>
                    </div>
                `;
                
                list.appendChild(card);
            });
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        // –ß–∞—Ç-–±–æ—Ç
        const botResponses = {
            '–∫–∞–∫–∏–µ': '–Ø —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ—Å–µ—Ç–∏—Ç—å –º–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è!',
            '—Ü–µ–Ω–∞': '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤–∫–ª—é—á–∞—é—Ç –º–µ—Å—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ü–µ–Ω–æ–≤—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ - –Ω–∏–∑–∫–∞—è, —Å—Ä–µ–¥–Ω—è—è –∏ –≤—ã—Å–æ–∫–∞—è. –í—ã–±–∏—Ä–∞–π—Ç–µ –ø–æ —Å–≤–æ–µ–º—É –±—é–¥–∂–µ—Ç—É!',
            '–≥–¥–µ': '–í—Å–µ –º–µ—Å—Ç–∞ –æ—Ç–º–µ—á–µ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ —Å–ª–µ–≤–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É, –∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ.',
            '–∫–∞–∫': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É –≤—ã—à–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π, –ø–æ–≥–æ–¥—ã, –≤—Ä–µ–º–µ–Ω–∏ –¥–Ω—è –∏ —Å–µ–∑–æ–Ω–∞. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏".',
            '–µ–¥–∞': '–í—ã–±–µ—Ä–∏—Ç–µ "–ï–¥–∞" –≤ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –∏ –Ω–∞–∂–º–∏—Ç–µ "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" - –ø–æ–ª—É—á–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –∏ –º–µ—Å—Ç –¥–ª—è –µ–¥—ã.',
            '–ø–∞—Ä–∫': '–í—ã–±–µ—Ä–∏—Ç–µ "–ü—Ä–∏—Ä–æ–¥–∞" –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - –Ω–∞–π–¥–µ—Ç–µ –ø–∞—Ä–∫–∏ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è –æ—Ç–¥—ã—Ö–∞.',
            '–º–∞—Ä—à—Ä—É—Ç': '–í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ. –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ - –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ —Å –º–∞—Ä—à—Ä—É—Ç–æ–º.',
            '–≤—Ä–µ–º—è': '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –¥–Ω—è (—É—Ç—Ä–æ, –¥–µ–Ω—å, –≤–µ—á–µ—Ä, –Ω–æ—á—å) –≤ —Ñ–æ—Ä–º–µ - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å —ç—Ç–æ –≤—Ä–µ–º—è.',
            '–ø–æ–º–æ—â—å': '–Ø –ø–æ–º–æ—â–Ω–∏–∫ nimad.visit! –ú–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –º–µ—Å—Ç–∞—Ö, –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å, –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö. –°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!'
        };
        
        function initChat() {
            const messagesEl = document.getElementById('chatMessages');
            messagesEl.innerHTML = '';
            addBotMessage('–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ø–æ–º–æ—â–Ω–∏–∫ nimad.visit. –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è –æ –º–µ—Å—Ç–∞—Ö, –≥–æ—Ä–æ–¥–∞—Ö, –º–∞—Ä—à—Ä—É—Ç–∞—Ö –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö!');
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addUserMessage(message);
                input.value = '';
                
                setTimeout(() => {
                    const response = getBotResponse(message.toLowerCase());
                    addBotMessage(response);
                }, 300);
            }
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function addUserMessage(text) {
            const messagesEl = document.getElementById('chatMessages');
            const msgEl = document.createElement('div');
            msgEl.className = 'message user-msg';
            msgEl.textContent = text;
            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function addBotMessage(text) {
            const messagesEl = document.getElementById('chatMessages');
            const msgEl = document.createElement('div');
            msgEl.className = 'message bot-msg';
            msgEl.textContent = text;
            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function getBotResponse(input) {
            for (const key in botResponses) {
                if (input.includes(key)) {
                    return botResponses[key];
                }
            }
            return '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–µ—Å—Ç–∞—Ö, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö, –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è –∏ –º–∞—Ä—à—Ä—É—Ç–∞—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –º–µ—Å—Ç–µ –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.';
        }
    </script>
</body>
</html>